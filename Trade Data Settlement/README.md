# corticon-on-marklogic

This project demonstrates how to run [Corticon.js](https://www.progress.com/corticon) decision services directly inside a [MarkLogic](https://www.marklogic.com/) database using [ml-gradle](https://github.com/marklogic-community/ml-gradle) for deployment and environment management.

It includes preconfigured roles, users, triggers, and modules for integrating Corticon.js rule execution into a MarkLogic-based data pipeline.

---

## 🧰 Prerequisites

- Java 11+
- Gradle 6.0+
- A running MarkLogic instance (locally or remotely)
- Optional: [Corticon.js Studio](https://www.progress.com/corticon) to generate `decisionServiceBundle.js`

---

## 📥 Get the Project

### Option 1: Clone with Git

```bash
git clone https://github.com/your-username/corticon-on-marklogic.git
cd corticon-on-marklogic
```

### Option 2: GitHub Desktop

1.  Open GitHub Desktop

2.  Clone the repository from GitHub

3.  Open a terminal in the cloned folder

### Option 3: Download ZIP

1.  Visit the [repository page](https://github.com/your-username/corticon-on-marklogic)

2.  Click the green **"Code"** button → **"Download ZIP"**

3.  Extract it, then open a terminal in the extracted folder
   
## ⚙️ Configuration

Before deploying, set the following properties in `gradle.properties`:
```
mlHost=localhost
mlUsername=admin
mlPassword=admin
```
🔐 Change mlUsername and mlPassword to match your MarkLogic admin account or environment-specific credentials.

## 🚀 Deploy the Project

From the project root, run:
```bash
gradle mlDeploy
```
This will:

*   Create the content, schemas, and triggers databases

*   Configure the REST server

*   Deploy security roles and users

*   Deploy Corticon.js modules to MarkLogic

*   Register a trigger to run Corticon on document update
  
To undeploy everything:
```bash
gradle mlUndeploy
```

## ✅ Upload a Document (Trigger Execution Test)

After deploying the app and modules, you can **trigger the decision service** by uploading a document into the target collection.

### 🔁 Using `curl`:

```curl --location --request PUT 'http://localhost:8004/v1/documents?uri=%2Fdata%2FledgerDemo%2FCASE01-SETTLED.json&perm%3Acorticonml-reader=read&perm%3Acorticonml-writer=update&collection=http%3A%2F%2Fexample.com%2Fdata%2Fledger' \ --header 'Content-Type: application/json' \ --digest --user corticonml-admin:admin \ --data '{ "marketCalendar": { "market": "XETR", "date": "2025-07-22T20:00:00.000-0400", "isBusinessDay": true }, "trade": { "quantity": "1000.000000", "tradeDate": "2025-07-20T20:00:00.000-0400", "assetClass": "Equity", "actualSettlementDate": "2025-07-22T20:00:00.000-0400", "market": "XETR", "agreedSettlementDate": "2025-07-22T20:00:00.000-0400", "netCashAmount": "45500.000000", "counterpartyId": "CPTY-001", "security": { "description": "BASF SE", "isin": "DE000BASF111" }, "settlementCurrency": "EUR", "price": "45.500000", "quantityRemaining": "0.000000", "tradeId": "CASE01-SETTLED", "tradeType": "Buy", "status": "Settled" }, "counterparty": { "counterpartyId": "CPTY-001", "lei": "5493001B3S86FF8BA273", "tier": "Tier 1", "name": "Alpha Trading" } }'```

### 📫 Or via Postman:
1. Open Postman and create a PUT request:

    `http://localhost:8004/v1/documents?uri=/data/ledgerDemo/CASE01-SETTLED.json&perm:corticonml-reader=read&perm:corticonml-writer=update&collection=http://example.com/data/ledger`

2. Set the **Authorization type** to **Digest Auth**

    *   Username: `corticonml-admin`

    *   Password: `corticonml-admin`

3.   In the **Headers** tab, add:
4.  In the **Body** tab, select **raw** and paste the same JSON shown above.

5.  Click **Send**

If everything is set up correctly, this will insert the document, and the **trigger** will automatically run the Corticon.js decision service on it.


## 🗂️ Project Structure

```bash
src/main/
├── ml-config/         # App server, database, user, role, trigger configuration
│   └── triggers/      # corticonTrigger.json
│   └── security/      # roles/ and users/
│   └── databases/     # content/triggers/schemas DBs
│   └── rest-api.json
├── ml-modules/
│   └── ext/           # Corticon.js modules and integration logic
│   └── options/       # Search options (e.g., corticonml-options.xml)
├── ml-schemas/
│   └── tde/           # Template-driven extraction (e.g., corticon.tde)
```

Key components:
*   `decisionServiceBundle.js` — generated by Corticon Studio; executes rules

*   `marklogic.trigger.sample.sjs` — trigger module logic that calls the Corticon decision service

*   `corticonTrigger.json` — trigger config tied to a collection


